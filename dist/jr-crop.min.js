/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version 1.0.0
 * @link https://github.com/JrSchild/jr-crop
 * @author Joram Ruitenschild
 * @license MIT
 */
!function(t,i,e,o){function s(t,o,s){function a(t,i,e,o,s){Date.now();o=Math.round(o),s=Math.round(s);for(var a=t.getContext("2d").getImageData(0,0,i,e),h=t.getContext("2d").getImageData(0,0,o,s),n=a.data,r=h.data,l=i/o,c=e/s,d=Math.ceil(l/2),g=Math.ceil(c/2),p=0;s>p;p++)for(var m=0;o>m;m++){for(var u=4*(m+p*o),v=0,f=0,w=0,b=0,x=0,H=0,_=0,X=(p+.5)*c,M=Math.floor(p*c);(p+1)*c>M;M++)for(var W=Math.abs(X-(M+.5))/g,Y=(m+.5)*l,j=W*W,C=Math.floor(m*l);(m+1)*l>C;C++){var I=Math.abs(Y-(C+.5))/d,S=Math.sqrt(j+I*I);S>=-1&&1>=S&&(v=2*S*S*S-3*S*S+1,v>0&&(I=4*(C+M*i),_+=v*n[I+3],w+=v,n[I+3]<255&&(v=v*n[I+3]/250),b+=v*n[I],x+=v*n[I+1],H+=v*n[I+2],f+=v))}r[u]=b/f,r[u+1]=x/f,r[u+2]=H/f,r[u+3]=_/w}t.getContext("2d").clearRect(0,0,Math.max(i,o),Math.max(e,s)),t.width=o,t.height=s,t.getContext("2d").putImageData(h,0,0)}function h(t){var i=this;i.options=t,i.promise=s.defer(),i.loadImage().then(function(t){i.imgWidth=t.naturalWidth,i.imgHeight=t.naturalHeight,i.options.modal.el.querySelector(".jr-crop-img").appendChild(i.imgSelect=t.cloneNode()),i.options.modal.el.querySelector(".jr-crop-select").appendChild(i.imgFull=t.cloneNode()),i.bindHandlers(),i.initImage()}),i.options.cancel=this.cancel.bind(this),i.options.crop=this.crop.bind(this)}function n(){if(this.options.height<this.imgHeight||this.options.width<this.imgWidth){var t=this.imgWidth/this.imgHeight,i=this.options.width/this.options.height;i>t?this.scale=this.last_scale=this.options.width/this.imgWidth:this.scale=this.last_scale=this.options.height/this.imgHeight}var e=(this.imgWidth-this.options.width)/2,o=(this.imgHeight-this.options.height)/2;this.posX=this.last_posX=-e,this.posY=this.last_posY=-o,this.setImageTransform()}function r(){var t=this;t.options.modal.remove().then(function(){t.promise.reject("canceled")})}function l(){function t(){i(),s.posX>a&&(s.posX=a),s.posX<n&&(s.posX=n),s.posY>h&&(s.posY=h),s.posY<r&&(s.posY=r)}function i(){var t=s.scale*s.imgWidth,i=s.scale*s.imgHeight;a=(t-s.imgWidth)/2,h=(i-s.imgHeight)/2,n=-(t-a-s.options.width),r=-(i-h-s.options.height)}var o,s=this,a=0,h=0,n=0,r=0,l=0,c=0,d=1,g=s.imgWidth/s.imgHeight,p=s.options.width/s.options.height;o=g>p?s.options.height/s.imgHeight:s.options.width/s.imgWidth;var m={prevent_default_directions:["left","right","up","down"]},u="touch transform drag dragstart dragend";s.options.allowRotation&&(u+=" rotate"),e.onGesture(u,function(i){switch(i.type){case"touch":s.last_scale=s.scale,s.last_rotate=s.rotate;break;case"drag":s.posX=s.last_posX+i.gesture.deltaX-l,s.posY=s.last_posY+i.gesture.deltaY-c,t();break;case"transform":s.scale=Math.max(o,Math.min(s.last_scale*i.gesture.scale,d)),t();break;case"dragend":s.last_posX=s.posX,s.last_posY=s.posY;break;case"dragstart":s.last_scale=s.scale,i.gesture.deltaX>1||i.gesture.deltaX<-1?(l=i.gesture.deltaX,c=i.gesture.deltaY):(l=0,c=0);break;case"rotate":s.rotate=s.last_rotate+i.gesture.rotation}s.setImageTransform()},s.options.modal.el,m)}function c(){var t=this,i="translate3d("+t.posX+"px,"+t.posY+"px, 0) scale3d("+t.scale+","+t.scale+", 1)rotate("+t.rotate+"deg)";t.imgSelect.style[e.CSS.TRANSFORM]=i,t.imgFull.style[e.CSS.TRANSFORM]=i}function d(){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=this.options.width/this.scale,t.height=this.options.height/this.scale;var e=this.imgWidth*this.scale,o=this.imgHeight*this.scale,s=(e-this.imgWidth)/2,h=(o-this.imgHeight)/2,n=(this.posX-s)/this.scale,r=(this.posY-h)/this.scale;if(i.translate(n,r),i.translate(this.imgWidth/2,this.imgHeight/2),i.rotate(this.rotate*Math.PI/180),i.drawImage(this.imgFull,this.imgWidth/2*-1,this.imgHeight/2*-1),this.options.resizeWidth||this.options.resizeHight){var l=this.options.resizeWidth,c=this.options.resizeHight;l||(l=c),c||(c=l),a(t,t.width,t.height,l,c)}var d=document.createElement("canvas");d.width=this.options.width,d.height=this.options.height;var g=d.getContext("2d");g.drawImage(t,0,0,this.options.width,this.options.height),i.drawImage(d,0,0,t.width,t.height),this.options.modal.remove(),this.promise.resolve(d)}function g(){var t=s.defer();return i.element("<img />").bind("load",function(i){t.resolve(this)}).bind("error",t.reject).prop("src",this.options.url),t.promise}function p(i){i=this.initOptions(i);var s=o.$new(!0);e.extend(s,i);var a='<div class="jr-crop modal">';return"header"==i.buttonLocation&&(a+=v),a+=f,"footer"==i.buttonLocation&&(a+=w),a+="</div>",s.modal=t.fromTemplate(a,{scope:s}),s.modal.show().then(function(){return new b(s).promise.promise})}function m(t,i,e,o,s){return a(t,i,e,o,s)}function u(t){var i;return i=e.extend({},this.defaultOptions),i=e.extend(i,t),i.aspectRatio&&(!i.width&&i.height&&(i.width=200),i.width?i.height=i.width/i.aspectRatio:i.height&&(i.width=i.height*i.aspectRatio)),i}var v='<div class="bar bar-header bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">{{cancelText}}</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">{{chooseText}}</button></div>',f='<div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div>',w='<div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">{{cancelText}}</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">{{chooseText}}</button></div>',b=e.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,rotate:0,last_scale:1,last_posX:0,last_posY:0,last_rotate:0,initialize:h,initImage:n,cancel:r,bindHandlers:l,setImageTransform:c,crop:d,loadImage:g});return{defaultOptions:{width:200,height:200,aspectRatio:0,cancelText:"Cancel",chooseText:"Choose",allowRotation:!0,buttonLocation:"footer"},crop:p,initOptions:u,resize:m}}i.module("jrCrop",["ionic"]).factory("$jrCrop",s),s.$inject=["$ionicModal","$rootScope","$q"]}(window,window.angular,window.ionic);