/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version 1.1.2
 * @link https://github.com/JrSchild/jr-crop
 * @author Joram Ruitenschild
 * @license MIT
 */

angular.module("jrCrop",["ionic"]).factory("$jrCrop",["$ionicModal","$rootScope","$q",function(t,i,e){var s=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,rotate:0,rotateAction:0,last_scale:1,last_posX:0,last_posY:0,last_rotate:0,initialize:function(t){var i=this;i.options=t,i.promise=e.defer(),i.loadImage().then(function(t){i.imgWidth=t.naturalWidth,i.imgHeight=t.naturalHeight,i.options.modal.el.querySelector(".jr-crop-img").appendChild(i.imgSelect=t.cloneNode()),i.options.modal.el.querySelector(".jr-crop-select").appendChild(i.imgFull=t.cloneNode()),i.bindHandlers(),i.initImage()}),i.options.cancel=this.cancel.bind(this),i.options.crop=this.crop.bind(this),i.options.rotateImage=this.rotateImage.bind(this)},initImage:function(){var t=this.imgWidth/this.imgHeight,i=this.options.width/this.options.height;this.scale=this.last_scale=i>t?this.options.width/this.imgWidth:this.options.height/this.imgHeight;var e=(this.imgWidth-this.options.width)/2,s=(this.imgHeight-this.options.height)/2;this.posX=this.last_posX=-e,this.posY=this.last_posY=-s,this.setImageTransform()},cancel:function(){var t=this;t.options.modal.remove().then(function(){t.promise.reject("canceled")})},bindHandlers:function(){var t,i=this,e=0,s=0,o=0,a=0,r=0,n=0,h=i.imgWidth/i.imgHeight,l=i.options.width/i.options.height;function c(){var t,r;t=i.scale*i.imgWidth,r=i.scale*i.imgHeight,e=(t-i.imgWidth)/2,s=(r-i.imgHeight)/2,o=-(t-e-i.options.width),a=-(r-s-i.options.height),i.posX>e&&(i.posX=e),i.posX<o&&(i.posX=o),i.posY>s&&(i.posY=s),i.posY<a&&(i.posY=a)}t=l<h?i.options.height/i.imgHeight:i.options.width/i.imgWidth;if(i.options.rotateGesture)var d="touch transform drag dragstart dragend rotate";else d="touch transform drag dragstart dragend";ionic.onGesture(d,function(e){switch(e.type){case"touch":i.last_scale=i.scale;break;case"drag":i.posX=i.last_posX+e.gesture.deltaX-r,i.posY=i.last_posY+e.gesture.deltaY-n,c();break;case"transform":i.scale=Math.max(t,Math.min(i.last_scale*e.gesture.scale,1)),c();break;case"dragend":i.last_posX=i.posX,i.last_posY=i.posY,i.options.rotateGesture&&(i.last_rotate=i.rotate);break;case"dragstart":i.last_scale=i.scale,e.gesture.deltaX>1||e.gesture.deltaX<-1?(r=e.gesture.deltaX,n=e.gesture.deltaY):(r=0,n=0);break;case"rotate":i.rotate=i.last_rotate+e.gesture.rotation}i.setImageTransform()},i.options.modal.el,{prevent_default_directions:["left","right","up","down"]})},setImageTransform:function(){var t=this,i="translate3d("+t.posX+"px,"+t.posY+"px, 0) scale3d("+t.scale+","+t.scale+", 1)rotate("+t.rotate+"deg)";t.imgSelect.style[ionic.CSS.TRANSFORM]=i,t.imgFull.style[ionic.CSS.TRANSFORM]=i},rotateImage:function(){var t=this;t.rotateAction--,t.rotateAction<0&&(t.rotateAction=3),t.last_rotate=t.rotate,t.rotate=90*t.rotateAction,t.setImageTransform()},crop:function(){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=this.options.width/this.scale,t.height=this.options.height/this.scale;var e=this.imgWidth*this.scale,s=this.imgHeight*this.scale,o=(e-this.imgWidth)/2,a=(s-this.imgHeight)/2,r=(this.posX-o)/this.scale,n=(this.posY-a)/this.scale;i.translate(r,n),i.translate(this.imgWidth/2,this.imgHeight/2),i.rotate(this.rotate*Math.PI/180),i.drawImage(this.imgFull,-this.imgWidth/2,-this.imgHeight/2),i.restore(),this.options.modal.remove(),this.promise.resolve(t)},loadImage:function(){var t=e.defer();return angular.element("<img />").bind("load",function(i){t.resolve(this)}).bind("error",t.reject).prop("src",this.options.url),t.promise}});return{defaultOptions:{width:0,height:0,aspectRatio:0,cancelText:"Cancel",chooseText:"Choose",template:'<div class="jr-crop modal"><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" ng-class="{\'jr-crop-select-circle\': circle}" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">{{cancelText}}</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">{{chooseText}}</button></div></div>',circle:!1,rotateGesture:!1},crop:function(e){e=this.initOptions(e);var o=i.$new(!0);return ionic.extend(o,e),o.modal=t.fromTemplate(e.template,{scope:o}),o.modal.show().then(function(){return new s(o).promise.promise})},initOptions:function(t){var i;return i=ionic.extend({},this.defaultOptions),(i=ionic.extend(i,t)).aspectRatio&&(!i.width&&i.height&&(i.width=200),i.width?i.height=i.width/i.aspectRatio:i.height&&(i.width=i.height*i.aspectRatio)),i}}}]);